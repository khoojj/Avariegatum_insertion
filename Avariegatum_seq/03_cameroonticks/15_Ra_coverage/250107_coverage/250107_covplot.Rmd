---
title: "Coverage plots for A.variegatum reads mapped to Rickettsia africase ESF-5 chromosome sequence"
output:
  html_document:
    toc: true
    number_sections: false
    df_print: paged
---

**Aim:** 
Identify *A. varigatum* tick populations with actual *R. africae* infection based on coverage profiles.  

**Hypothesis:** Putatively infected ticks have even coverage across the *R. africae* genome while uninfected ticks have uneven coverage due to missing regions in the tick-genome-integrated sequence.   

**Approach:** Mapping bam files from the variant analysis were used to generate coverage profile across the *R. africae* genome in 1kb windows using Mosdepth, with downstream statistical analysis and visualisation in R. 

---
```{r}
#Load libraries
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE)
set.seed(1)
library(tidyverse); library(readxl); library(svglite)
```

### Data inputs
1. Load and merge data
```{r}

# Load the coverage matrix and the metadata
coverage_df <- read_excel("r_africae_1kb_coverage.xlsx")
meta_df <- read_excel("meta.xlsx")

# Pivot coverage to "long" format so we can join by sample ID
df_long <- coverage_df %>%
  pivot_longer(cols = -c(chrom, start, end), 
               names_to = "IID", 
               values_to = "raw_coverage")

# Join with metadata to get the 'Sca12' column (High/Low)
df_combined <- df_long %>%
  left_join(meta_df %>% select(IID, Sca12), by = "IID") %>%
  filter(!is.na(Sca12)) # Remove samples not in metadata
```

### Normalise and calculate statistics
```{r}
# 1. Normalize within each sample by Reads Per Million mapped to the chromosome
df_norm <- df_combined %>%
  group_by(IID) %>%
  mutate(norm_cov = (raw_coverage / sum(raw_coverage)) * 1e6) %>%
  ungroup()

# 2. Calculate Mean and Error (SD) per genomic window per group
plot_data <- df_norm %>%
  group_by(start, Sca12) %>%
  summarise(
    mean_val = mean(norm_cov),
    sd_val = sd(norm_cov),
    .groups = "drop"
  )
```

### Produce the line plot for high (putatively infected) and low (uninfected) groups
```{r}
coverage_plot_all <- ggplot(plot_data, aes(x = start, y = mean_val, color = Sca12, fill = Sca12)) +
  # Shaded area for Standard Deviation
  geom_ribbon(aes(ymin = mean_val - sd_val, ymax = mean_val + sd_val), 
              alpha = 0.2, color = NA) +
  # Mean line
  geom_line(size = 0.7) +
  scale_color_manual(values = c("High" = "#9e0e0599", "Low" = "#05579e99")) +
  scale_fill_manual(values = c("High" = "#9e0e0599", "Low" = "#05579e99")) +
  theme_minimal() +
  # REMOVE GRID LINES
  theme(
    panel.grid.major = element_blank(), # Removes major grid lines
    panel.grid.minor = element_blank(), # Removes minor grid lines
    axis.line = element_line(color = "darkgrey") # Optional: adds clear x/y axes
  ) +
  scale_x_continuous(
    breaks = seq(0, max(plot_data$start), by = 200000), # Ticks every 200kb
    labels = scales::label_number(scale = 1e-3, suffix = "kb") 
    ) +
      
  labs(
    x = "Genomic Position (bp)",
    y = "Coverage (reads per million)",
    color = "Group (sca12)",
    fill = "Group (sca12)"
  ) 

coverage_plot_all 
```
Legend: 
Line represents mean
Ribbon represents 1SD

### Summary findings
Distinct coverage profiles in putatively infected (high) and uninfected (low) populations.

### Save plot
```{r}
ggsave("r_africae_coverage_all.svg", coverage_plot_all, device = "svg", width = 8, height = 4)
```

### Count how many samples in High (sca12 > 1) or Low (sca12 < 1) groups
```{r}
# 1. Simple count of samples in each group
sample_counts <- df_combined %>%
  group_by(Sca12) %>%
  summarise(number_of_samples = n_distinct(IID))

# 2. Print the result
print(sample_counts)
```

### Check the effect of location on the coverage
Made new plots for samples in High or Low groups only:

#### Samples in Low group
```{r}
# 1. Filter for Low group and ensure Location is present
low_group_summary <- df_norm %>%
  filter(Sca12 == "Low") %>%
  left_join(meta_df %>% select(IID, Location), by = "IID") %>%
  # 2. Group by Location and genomic window
  group_by(start, Location) %>%
  summarise(
    mean_val = mean(norm_cov),
    sd_val = sd(norm_cov),
    .groups = "drop"
  )

# 3. Plot Mean + SD Ribbon for each Location
ggplot(low_group_summary, aes(x = start, y = mean_val, color = Location, fill = Location)) +
  # Shaded area for variation within each location
  geom_ribbon(aes(ymin = mean_val - sd_val, ymax = mean_val + sd_val), 
              alpha = 0.2, color = NA) +
  # Mean line for each location
  geom_line(linewidth = 0.7) +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black")
  ) +
  labs(
    x = "Genomic Position (kb)",
    y = "Normalized Coverage (RPM)",
    color = "Location",
    fill = "Location"
  ) +
  scale_x_continuous(
    breaks = seq(0, max(low_group_summary$start), by = 200000), 
    labels = scales::label_number(scale = 1e-3, suffix = "kb")
  )
```

#### Samples in High group
```{r}
# 1. Filter for High group and ensure Location is present
high_group_summary <- df_norm %>%
  filter(Sca12 == "High") %>%
  left_join(meta_df %>% select(IID, Location), by = "IID") %>%
  # 2. Group by Location and genomic window
  group_by(start, Location) %>%
  summarise(
    mean_val = mean(norm_cov),
    sd_val = sd(norm_cov),
    .groups = "drop"
  )

# 3. Plot Mean + SD Ribbon for each Location (High Group Only)
ggplot(high_group_summary, aes(x = start, y = mean_val, color = Location, fill = Location)) +
  # Shaded area for variation within each location
  geom_ribbon(aes(ymin = mean_val - sd_val, ymax = mean_val + sd_val), 
              alpha = 0.2, color = NA) +
  # Mean line for each location
  geom_line(linewidth = 0.7) +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black")
  ) +
  labs(
    x = "Genomic Position (kb)",
    y = "Normalized Coverage (RPM)",
    color = "Location",
    fill = "Location"
  ) +
  scale_x_continuous(
    breaks = seq(0, max(high_group_summary$start), by = 200000), 
    labels = scales::label_number(scale = 1e-3, suffix = "kb")
  )
```

### Summary findings
Distinct coverage profiles in putatively infected (high) and uninfected (low) populations.
Not affected by location.